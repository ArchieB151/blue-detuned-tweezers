"""
make_flux_csvs.py

Creates TWO CSVs from your in-script arrays:
  1) rb_flux.csv
  2) caf_flux.csv

Format (both):
  state,bh_mK,flux_s,flux_err

Rb CSV additionally includes:
  red_power_mW, blue_power_mW

Notes
- Any trailing "missing" zeros in CaF (flux==0 or err==0) are converted to NaN by default,
  so they won't break log plots and they behave like missing data.
"""

from __future__ import annotations

from pathlib import Path
import numpy as np
import pandas as pd


# -------------------- helpers --------------------
def to_float_array(x) -> np.ndarray:
    return np.asarray(x, dtype=float)


def zeros_to_nan(a: np.ndarray) -> np.ndarray:
    """Convert exact zeros to NaN (useful when 0 was used as 'missing')."""
    a = np.asarray(a, dtype=float).copy()
    a[a == 0.0] = np.nan
    return a


def make_state_df(state: str, bh, flux, err, *, nanify_zeros: bool = True) -> pd.DataFrame:
    bh = to_float_array(bh)
    flux = to_float_array(flux)
    err = to_float_array(err)

    if nanify_zeros:
        flux = zeros_to_nan(flux)
        err = zeros_to_nan(err)

    if not (len(bh) == len(flux) == len(err)):
        raise ValueError(
            f"Length mismatch for {state}: len(bh)={len(bh)}, len(flux)={len(flux)}, len(err)={len(err)}"
        )

    df = pd.DataFrame(
        {
            "state": state,
            "bh_mK": bh,
            "flux_s": flux,
            "flux_err": err,
        }
    )
    # Sort for nicer plotting / fitting
    return df.sort_values("bh_mK", kind="mergesort").reset_index(drop=True)


def save_csv(df: pd.DataFrame, outpath: str | Path) -> None:
    outpath = Path(outpath)
    df.to_csv(outpath, index=False)
    print(f"Wrote: {outpath.resolve()}  ({len(df)} rows)")


# -------------------- YOUR DATA (paste/keep as-is) --------------------
# Rb
rates = np.array(
    [
        56.18685466563845,
        48.572029856686484,
        28.369282066681713,
        17.030473100825528,
        8.425309961717318,
        4.3118295034284015,
        1.8835094105171646,
        1.2282056203182095,
        0.7833437649279795,
        0.3092110011109296,
        0.26964977122297507,
        0.13246240500201578,
    ]
)
error = np.array(
    [
        2.9338942244825983,
        3.702538822925607,
        1.46958345276454,
        1.4811241163318623,
        0.4608136139542488,
        0.29722724078086793,
        0.18324482917605378,
        0.14460668315696856,
        0.06472022097418657,
        0.07145576927273113,
        0.08282877384037951,
        0.08027823778673727,
    ]
)

red_power_R = np.array(
    [
        1.22610123,
        1.4747634,
        1.68141889876,
        1.87068578,
        2.050367223,
        2.2237289,
        2.39244839,
        2.55774345,
        2.720446822,
        2.88104318,
        3.0400279573,
        3.197613412,
        3.3539877,
    ]
)
blue_power_R = np.array(
    [
        0.0,
        0.4477374,
        0.819813605904,
        1.16058060,
        1.4840895019,
        1.79621933,
        2.099992013,
        2.397598983,
        2.690539558,
        2.97968653,
        3.2659319553,
        3.549657907,
        3.83120290,
    ]
)

red_power_R = red_power_R[: len(rates)]
blue_power_R = blue_power_R[: len(rates)]

Rb_Bh = [
    -5.72833921e-05,
    3.01396470e-02,
    6.52731837e-02,
    1.01130581e-01,
    1.36843180e-01,
    1.73132262e-01,
    2.10554553e-01,
    2.46723874e-01,
    2.82650018e-01,
    3.20066921e-01,
    3.56104434e-01,
    3.93936257e-01,
    4.31707198e-01,
]

# CaF flux + errors
Potentals_1minus_minus1_rates = [
    1662.3333331389363,
    1447.0952379541,
    1356.130952297795,
    1061.166666728351,
    953.0984849509438,
    741.0133201664678,
    514.8994546769304,
    336.62935937118067,
    114.50117110027186,
    24.214702628951912,
    4.196184261733437,
    0.7408590515675177,
    0.17490153111119272,
]
Potentals_1minus_minus1_error = [
    30.02488679478406,
    51.919538192165234,
    51.5514259902761,
    28.80825640780814,
    38.50663872629965,
    19.790381198187138,
    18.195856330685988,
    14.916897757222449,
    2.4501868097449275,
    0.7378161204857652,
    0.27421030238496363,
    0.07660262945708292,
    0.06075010404726126,
]

Potentals_1minus_0_rates = [
    1457.1428570096755,
    1101.666666711445,
    772.1153847678179,
    413.8227274180055,
    162.0622238140503,
    53.24712919064085,
    16.78390838414923,
    4.707936702579026,
    1.000657878446487,
    0.19361028681371276,
    0.08336880797214631,
    0.0,
    0.0,
]
Potentals_1minus_0_error = [
    45.70078061428999,
    53.403053682718124,
    12.866459689434222,
    12.790231098118563,
    3.368277921433057,
    1.395114692134414,
    0.38226875214084155,
    0.2852841274285037,
    0.08487952898957342,
    0.058411560102888595,
    0.028005152309524255,
    0.0,
    0.0,
]

Potentals_1minus_1_rates = [
    1441.1904760501293,
    1288.0952380316307,
    1152.2500000211019,
    966.426767781599,
    651.3392320043083,
    253.77021912702108,
    19.336633019462077,
    1.2097436761873768,
    0.08675828634434553,
    0.0,
    0.0,
    0.0,
    0.0,
]
Potentals_1minus_1_error = [
    41.750935178695435,
    32.07112805862102,
    28.06601838862064,
    35.56655902592228,
    14.3788438935336,
    8.621264324859425,
    0.5251968103233956,
    0.12327326979463303,
    0.02906264529836691,
    0.0,
    0.0,
    0.0,
    0.0,
]

Potentals_0_0_rates = [
    1473.5952379715904,
    1321.5476189535975,
    1058.8333333852308,
    933.2735043882755,
    690.3054030892661,
    397.52201029149836,
    137.53024254360258,
    21.004100413676476,
    2.86486150013181,
    0.3238971792934878,
    0.050180629122292805,
    0.0,
    0.0,
]
Potentals_0_0_error = [
    44.13920763168994,
    48.29234648384618,
    22.146119680464512,
    29.993516795705563,
    17.849337126613655,
    14.660071354526746,
    5.0033530624311755,
    0.5975294469127044,
    0.2049436734420063,
    0.05373168170360191,
    0.03647641533581848,
    0.0,
    0.0,
]

Potentals_1_1_rates = [
    1495.5238093716848,
    1291.8055554860193,
    1077.2777778341108,
    841.9743591133422,
    535.7171930962305,
    264.2065034190533,
    44.35162299034549,
    4.265788583632299,
    0.6058638682882258,
    0.06549197350477606,
    0.0,
    0.0,
    0.0,
]
Potentals_1_1_error = [
    41.42164995975301,
    48.037823184550824,
    30.437645665816465,
    21.89930093807636,
    24.53012446223476,
    11.231548477016611,
    1.6724110716170921,
    0.3104751445911041,
    0.07114670679776347,
    0.026782637356898634,
    0.0,
    0.0,
    0.0,
]

Potentals_1_0_rates = [
    1549.9999998335672,
    1482.8095236687373,
    1299.9404761267883,
    1059.7777778272837,
    896.0808082056349,
    688.9430709740998,
    511.4093568827758,
    302.06142667668007,
    82.85089228925042,
    15.260397960207843,
    2.624874552691184,
    0.36867307397864296,
    0.05383543511980117,
]
Potentals_1_0_error = [
    37.92900236716323,
    38.587392986161134,
    29.07385214466549,
    22.777657318802227,
    22.217420144408134,
    26.158910643849055,
    7.9353835367021555,
    10.241932990446283,
    1.6091331440916352,
    0.32111045224758455,
    0.1914014040798683,
    0.06111712307394462,
    0.027462769412802766,
]

Potentals_1_minus1_rates = [
    1468.035714141207,
    1358.214285635941,
    1076.6031746553508,
    803.5955712423265,
    510.5187950857301,
    235.35209908290517,
    35.480627186477804,
    3.885446572895193,
    0.49952674649677425,
    0.06615662654246421,
    0.0,
    0.0,
    0.0,
]
Potentals_1_minus1_error = [
    43.05748018517715,
    41.893073441014515,
    41.072433578363814,
    13.234050752190111,
    19.554007168915447,
    7.446266163415044,
    0.7036363832759173,
    0.5504514908517749,
    0.07297071179615347,
    0.027357913030087364,
    0.0,
    0.0,
    0.0,
]

Potentals_2_minus2_rates = [
    1633.9999998075423,
    1475.952380789537,
    1379.1666665603548,
    1195.6746031831271,
    983.656565756139,
    798.3173494602386,
    577.4534315343221,
    377.9751711001446,
    154.14773195252755,
    36.15075276466047,
    6.421832663772082,
    1.3174442104198874,
    0.20874157919181338,
]
Potentals_2_minus2_error = [
    41.005269155258226,
    36.351372349237,
    33.20411459558272,
    29.37180852673722,
    38.421567334500594,
    22.189490916010236,
    14.920327989791902,
    13.554556070235948,
    5.6136726626263258,
    1.0538650732438632,
    0.25826799046561233,
    0.128701300558807,
    0.05400816351627023,
]

Potentals_2_minus1_rates = [
    1387.3809522548613,
    1244.404761867958,
    1059.3611111692212,
    801.9923411379267,
    483.9586430323751,
    193.32790013772302,
    28.060431961682333,
    3.0069422942718202,
    0.20575654952095673,
    0.04891614262627127,
    0.016233766310375597,
    0.01968503945729049,
    0.0,
]
Potentals_2_minus1_error = [
    36.73848870099506,
    42.10654054099951,
    34.87386760270006,
    26.72568832767651,
    14.290724640464235,
    5.579471310789499,
    0.3764386349494615,
    0.27906394438804294,
    0.057014293076688205,
    0.02492728838477621,
    0.016233766310375597,
    0.01968503945729049,
    0.0,
]

Potentals_2_0_rates = [
    1410.6666665314322,
    1210.7341269733352,
    903.2319625968636,
    594.9488797140377,
    285.7029565377458,
    46.28454515368826,
    3.122729773683355,
    0.3075374133782331,
    0.030030029656079794,
    0.0,
    0.0,
    0.0,
    0.0,
]
Potentals_2_0_error = [
    41.21725586361926,
    40.08153084743441,
    42.836925818880715,
    14.582914291574257,
    6.73351719874371,
    1.696085242137716,
    0.14407272703224278,
    0.07369513821752745,
    0.015290542668972704,
    0.0,
    0.0,
    0.0,
    0.0,
]

Potentals_2_1_rates = [
    1468.999999848293,
    1242.1825396425477,
    1012.5270563501601,
    752.564102719379,
    482.2723476912656,
    164.29378597024976,
    17.553303624290276,
    2.0481370070354856,
    0.13419608142528963,
    0.03630529408352852,
    0.0,
    0.0,
    0.0,
]
Potentals_2_1_error = [
    63.54999141739404,
    47.958156509891595,
    35.54804189156347,
    25.48672612482833,
    7.888395919633915,
    3.0910837880185555,
    0.36792330267198525,
    0.2729570892890198,
    0.03345940114900093,
    0.024206718039266596,
    0.0,
    0.0,
    0.0,
]

Potentals_2_2_rates = [
    1653.666666472052,
    1445.1428570128323,
    1286.7261904315128,
    1084.376984166949,
    906.7373738623137,
    757.4307360834266,
    541.8538873285627,
    342.29684640375945,
    118.19087297348906,
    21.44201378600946,
    2.5397923258966855,
    0.34011471951863537,
    0.015432098839293442,
]
Potentals_2_2_error = [
    41.50100400120879,
    61.88285324856206,
    26.96910323517877,
    37.812186067878635,
    23.83717967180432,
    21.747710319346083,
    12.428980324440039,
    11.67945941647098,
    2.780180004346125,
    0.6119354221462213,
    0.2697006306537777,
    0.0821764282828676,
    0.015432098839293442,
]

# CaF barrier heights (min)
Potentals_2_1_Bh_min = [
    -2.17663463e-05,
    1.01344465e-02,
    2.46096518e-02,
    3.97423892e-02,
    5.59388763e-02,
    7.21217042e-02,
    8.87907130e-02,
    1.05806162e-01,
    1.22412411e-01,
    1.39697332e-01,
    1.56514655e-01,
    1.72753670e-01,
    1.88315413e-01,
]
Potentals_2_2_Bh_min = [
    -2.54243982e-05,
    8.63609788e-03,
    2.15639095e-02,
    3.41268572e-02,
    4.66591841e-02,
    5.93282229e-02,
    7.21424921e-02,
    8.47123918e-02,
    9.73073518e-02,
    1.10082314e-01,
    1.23599856e-01,
    1.37381492e-01,
    1.51259153e-01,
]
Potentals_1minus_minus1_Bh_min = [
    -2.55333020e-05,
    8.08874309e-03,
    2.07627352e-02,
    3.33351096e-02,
    4.60493240e-02,
    5.91849766e-02,
    7.23374973e-02,
    8.53462781e-02,
    9.83656152e-02,
    1.11425916e-01,
    1.24985510e-01,
    1.38548131e-01,
    1.51800954e-01,
]
Potentals_1minus_0_Bh_min = [
    -1.24061055e-05,
    1.54448708e-02,
    3.32568441e-02,
    5.05041381e-02,
    6.70129247e-02,
    8.33345769e-02,
    9.87475042e-02,
    1.13584002e-01,
    1.28113861e-01,
    1.42782369e-01,
    1.57150793e-01,
    1.71398269e-01,
    1.85476626e-01,
]
Potentals_1minus_1_Bh_min = [
    -3.14059653e-05,
    6.35235376e-03,
    1.91091595e-02,
    3.22694450e-02,
    4.63315376e-02,
    6.16685527e-02,
    7.74923168e-02,
    9.38277196e-02,
    1.11622838e-01,
    1.29339785e-01,
    1.48733267e-01,
    1.68167109e-01,
    1.87072774e-01,
]
Potentals_0_0_Bh_min = [
    -2.31179001e-05,
    9.93139209e-03,
    2.39967375e-02,
    3.82102765e-02,
    5.29212805e-02,
    6.76403482e-02,
    8.22940017e-02,
    9.70056781e-02,
    1.12518227e-01,
    1.27438165e-01,
    1.42452163e-01,
    1.58318402e-01,
    1.74198660e-01,
]
Potentals_1_minus1_Bh_min = [
    -2.19894650e-05,
    1.07604054e-02,
    2.54832905e-02,
    4.04676561e-02,
    5.61414875e-02,
    7.15531676e-02,
    8.70474138e-02,
    1.03271667e-01,
    1.19019528e-01,
    1.35072749e-01,
    1.51749262e-01,
    1.68438454e-01,
    1.84916860e-01,
]
Potentals_1_0_Bh_min = [
    -2.53018609e-05,
    8.29810532e-03,
    2.11304699e-02,
    3.38922716e-02,
    4.67070610e-02,
    6.00579141e-02,
    7.32839527e-02,
    8.64219689e-02,
    9.95910603e-02,
    1.12792346e-01,
    1.26694430e-01,
    1.40240948e-01,
    1.53666619e-01,
]
Potentals_1_1_Bh_min = [
    -2.20453302e-05,
    1.07504155e-02,
    2.54545560e-02,
    4.03985900e-02,
    5.60129109e-02,
    7.13566479e-02,
    8.67720171e-02,
    1.02852719e-01,
    1.18574870e-01,
    1.34458676e-01,
    1.51079236e-01,
    1.67715934e-01,
    1.84201157e-01,
]
Potentals_2_minus2_Bh_min = [
    -2.58032637e-05,
    7.88574609e-03,
    2.04003090e-02,
    3.27664635e-02,
    4.53394097e-02,
    5.82065461e-02,
    7.12605622e-02,
    8.40943756e-02,
    9.69124839e-02,
    1.09782947e-01,
    1.22912159e-01,
    1.36507206e-01,
    1.49559677e-01,
]
Potentals_2_minus1_Bh_min = [
    -2.19677925e-05,
    1.08176950e-02,
    2.55944327e-02,
    4.06408111e-02,
    5.63893628e-02,
    7.18789539e-02,
    8.74721797e-02,
    1.03840716e-01,
    1.19700503e-01,
    1.36098170e-01,
    1.53027152e-01,
    1.69950455e-01,
    1.86521717e-01,
]
Potentals_2_0_Bh_min = [
    -2.05980015e-05,
    1.22771318e-02,
    2.82125756e-02,
    4.45722928e-02,
    6.11482851e-02,
    7.75832640e-02,
    9.47089727e-02,
    1.11421093e-01,
    1.28953545e-01,
    1.46929603e-01,
    1.64669688e-01,
    1.82217411e-01,
    2.00012412e-01,
]


# -------------------- build & write CSVs --------------------
def main() -> None:
    # Rb: keep your convention Rb_Bh[:-1] to match rates/error length
    rb_df = make_state_df(
        "Rb",
        bh=Rb_Bh[:-1],
        flux=rates,
        err=error,
        nanify_zeros=False,  # Rb has no missing zeros; don't touch
    )
    rb_df["red_power_mW"] = to_float_array(red_power_R)
    rb_df["blue_power_mW"] = to_float_array(blue_power_R)
    save_csv(rb_df, "rb_flux.csv")

    # CaF: assemble each state
    caf_dfs = []
    caf_dfs.append(
        make_state_df(
            "Potentals_1minus_minus1",
            Potentals_1minus_minus1_Bh_min,
            Potentals_1minus_minus1_rates,
            Potentals_1minus_minus1_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_1minus_0",
            Potentals_1minus_0_Bh_min,
            Potentals_1minus_0_rates,
            Potentals_1minus_0_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_1minus_1",
            Potentals_1minus_1_Bh_min,
            Potentals_1minus_1_rates,
            Potentals_1minus_1_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_0_0",
            Potentals_0_0_Bh_min,
            Potentals_0_0_rates,
            Potentals_0_0_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_1_1",
            Potentals_1_1_Bh_min,
            Potentals_1_1_rates,
            Potentals_1_1_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_1_0",
            Potentals_1_0_Bh_min,
            Potentals_1_0_rates,
            Potentals_1_0_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_1_minus1",
            Potentals_1_minus1_Bh_min,
            Potentals_1_minus1_rates,
            Potentals_1_minus1_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_2_minus2",
            Potentals_2_minus2_Bh_min,
            Potentals_2_minus2_rates,
            Potentals_2_minus2_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_2_minus1",
            Potentals_2_minus1_Bh_min,
            Potentals_2_minus1_rates,
            Potentals_2_minus1_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_2_0",
            Potentals_2_0_Bh_min,
            Potentals_2_0_rates,
            Potentals_2_0_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_2_1",
            Potentals_2_1_Bh_min,
            Potentals_2_1_rates,
            Potentals_2_1_error,
        )
    )
    caf_dfs.append(
        make_state_df(
            "Potentals_2_2",
            Potentals_2_2_Bh_min,
            Potentals_2_2_rates,
            Potentals_2_2_error,
        )
    )

    caf_df = pd.concat(caf_dfs, ignore_index=True)
    save_csv(caf_df, "caf_flux.csv")


if __name__ == "__main__":
    main()